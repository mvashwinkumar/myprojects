<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Update Discount (Admin)</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        
        <link type="text/css" href="/BasketApp/scripts/bootstrap/css/bootstrap_yeti.css" rel="stylesheet">
        <link type="text/css" href="/BasketApp/styles/BasketStyle.css" rel="stylesheet">
        <script src="/BasketApp/scripts/handlebars-v1.3.0.js" type="text/javascript"></script>
        <script src="/BasketApp/scripts/jquery-1.10.2.js"></script>
        <script src="/BasketApp/scripts/bootstrap/js/bootstrap.js"></script>
        <script src="/BasketApp/scripts/jsUtil.js"></script>
        <script>
            
          $(function()    {
                var request = {resultsPerPage: 200, currentPage: 1};
                request = JSON.stringify(request);
                $.ajax({
                    type:"POST",
                    contentType:"application/json",
                    data:request,           
                    url:"/BasketApp/api/Products/get",
            }).done(function(data){
            var productList = data.products;
            var table = document.getElementById("productsListTable");
            var count =1; //to start count after table header
            for (i=0; i<productList.length;i++){
            
            var row = table.insertRow(count);
            var itemNoCell = row.insertCell(0);
            var itemNameCell = row.insertCell(1);
            var unitPriceCell = row.insertCell(2);
            var quantityCell = row.insertCell(3);
            var discountCell = row.insertCell(4);
            var discountedPriceCell = row.insertCell(5);
            var updateButtonCell = row.insertCell(6);
            
            itemNoCell.innerHTML = productList[i].inventoryId;
            itemNameCell.innerHTML = productList[i].name;
            unitPriceCell.innerHTML = '<label id="price_'+productList[i].inventoryId+'" data-unitprice="'+productList[i].price+'">'+formatCurrency(productList[i].price)+'</label>';
            quantityCell.innerHTML = productList[i].quantity;
            discountCell.innerHTML = '<input class="form-control" id="discount_'+productList[i].inventoryId+'" value="'+productList[i].discount+'" type="number" max="100" min="0" data-inventoryId='+productList[i].inventoryId+'>';
            discountedPriceCell.innerHTML = '<label id="discounted_price_'+productList[i].inventoryId+'">'+ formatCurrency(Number(productList[i].price)*Number(100-productList[i].discount)/100) +'</label>';
            updateButtonCell.innerHTML = '<button class="btn-xs btn-info" id="update_btn_'+productList[i].inventoryId+'" data-inventoryId='+productList[i].inventoryId+'><span class="glyphicon glyphicon-refresh" style="color: #F04124"></span></button>';
            $('#update_btn_'+productList[i].inventoryId).prop("disabled",true).removeClass('btn-info').addClass('btn-default');
            count++;
            }
             
             $("button[id^='update_btn_']").click(function(){
            var productId = $(this).data("inventoryid");
            var discount = $('#discount_'+productId).val();
            var updateData = {inventoryId: productId, productDiscount: discount};
            updateData = JSON.stringify(updateData);

            $.ajax({
           contentType:"application/json",
           type:"POST",
           data:updateData,           
           url:"/BasketApp/api/Products/updateDiscount"
            }).done(function(data){
               
            $('#discount_'+data.inventoryId).val(data.discount);
            $('#discounted_price_'+data.inventoryId).text(formatCurrency(Number(data.price)*Number(100-data.discount)/100));
            $('#update_btn_'+data.inventoryId).prop("disabled",true).removeClass('btn-info').addClass('btn-default');
            
            });
        });
        
        $("input[id^='discount_']").on("change",(function(){
            var productId = $(this).data("inventoryid");
            var discount = $('#discount_'+productId).val();
            var price = $('#price_'+productId).data("unitprice");
            var discountedPrice = Number(price)*Number(100-discount)/100;
            $('#discounted_price_'+productId).text(formatCurrency(discountedPrice));
            $('#update_btn_'+productId).prop("disabled",false).removeClass('btn-default').addClass('btn-info');
        }))
        
      }); 
      
      
//      var ssEventDisc = new EventSource("discount");
//      ssEventDisc.onmessage = function(data){
//          var tempString = JSON.parse(data.data);
//          $("#testdiv").html(JSON.stringify(tempString));
//      }
      
      
  });
            
        </script>
    </head>
    <body>
        <div class="col-lg-12">
            <div class="row">
                <br>
                <br>
                <h2 class="text-primary text-center">List of Food Items in Inventory</h2>
                <br>
                <br>
                <div id="testdiv"></div>
                    <div class="bs-example table-responsive col-lg-8 col-lg-offset-2">
              <table id="productsListTable" class="table table-striped table-bordered table-hover text-center">
                  <thead>
                  <tr>
                    <th>Item No.</th>
                    <th>Item Name</th>
                    <th>Unit Price</th>
                    <th>Quantity</th>
                    <th>Discount(in %)</th>
                    <th>Discounted Price</th>
                    <th>Update</th>
                  </tr>
                </thead>
              </table>
                        
            </div>
                </div>
        </div>
    </body>
</html>
